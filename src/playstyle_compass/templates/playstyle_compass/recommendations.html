{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_header %}
<h3>GAME RECOMMENDATIONS</h3>
{% endblock page_header %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/playstyle_compass/pagination.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/playstyle_compass/recommendation_sections.css' %}">

<div class="category-buttons">
  <button class="category-button" data-category="gaming_history">Gaming History</button>
  <button class="category-button" data-category="preferred_platforms">Preferred Platforms</button>
  <button class="category-button" data-category="favorite_genres">Favorite Genres</button>
  <button class="category-button" data-category="common_genres_platforms">Common Genres and Platforms</button>
</div>

{% for category, paginated_page in paginated_games.items %}
<div class="game-recommendations-container {{ category|slugify }}">
  {% if paginated_page.object_list %}
    <h4>Games you might like based on your {{ category|format_category_label }}: {{ user_preferences|getattr:category }} </h4>
    <ul>
      {% for game in paginated_page.object_list %}
      {% include "playstyle_compass/game_recommendations_section.html" %}
      {% endfor %}
    </ul>
    <div class="pagination">
      <span class="step-links">
      {% if paginated_page.has_previous %}
        <a href="?category={{ category }}&{{ category|slugify }}_page=1">&laquo; first</a>
        <a href="?category={{ category }}&{{ category|slugify }}_page={{ paginated_page.previous_page_number }}">previous</a>
      {% endif %}
      
      <span class="current-page">{{ paginated_page.number }}</span>

      {% if paginated_page.has_next %}
      <a href="?category={{ category }}&{{ category|slugify }}_page={{ paginated_page.next_page_number }}">next</a>
      <a href="?category={{ category }}&{{ category|slugify }}_page={{ paginated_page.paginator.num_pages }}">last &raquo;</a>
      {% endif %}
      </span>
    </div>
  {% else %}
    <h4>No game recommendations based on your {{ category|format_category_label }}: {{ user_preferences|getattr:category }}</h4>
  {% endif %}
</div>
{% endfor %}

<script>
  function hideAllContainers() {
    const gameContainers = document.querySelectorAll('.game-recommendations-container');
    gameContainers.forEach(container => {
      container.style.display = 'none';
    });
  }

  function showCategoryContainer(category) {
    const selectedContainer = document.querySelector(`.${category}`);
    if (selectedContainer) {
      selectedContainer.style.display = 'block';
    }
  }

  function getCategoryAndPageFromURL() {
    const searchParams = new URLSearchParams(window.location.search);
    const category = searchParams.get('category') || 'gaming_history';
    const page = searchParams.get(`${category}_page`) || 1;
    return {
      category,
      page
    };
  }

  const {
    category,
    page
  } = getCategoryAndPageFromURL();
  hideAllContainers();
  showCategoryContainer(category);

  const buttons = document.querySelectorAll('.category-button');
  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const selectedCategory = button.dataset.category;
      hideAllContainers();
      showCategoryContainer(selectedCategory);

      // Update the URL without page reload
      const newUrl = `?category=${selectedCategory}`;
      history.pushState(null, null, newUrl);
    });
  });

  window.addEventListener('popstate', (event) => {
    const {
      category,
      page
    } = getCategoryAndPageFromURL();
    hideAllContainers();
    showCategoryContainer(category);
  });
</script>

{% endblock %}
